<!DOCTYPE html>
<html lang="en">
<head>
    <!-- SEO & Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FlowState Days | Minimalist Countdown Timer</title>
    <meta name="description" content="FlowState Days is a minimalist event tracking and countdown tool. Features include stealth notes, pinned events, custom recurring cycles, and local data privacy.">
    <meta name="keywords" content="countdown timer, event tracker, days left, minimalist app, productivity tool, flowstate">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #0f172a;
            --sidebar-bg: rgba(15, 23, 42, 0.95);
            --card-bg: rgba(30, 41, 59, 0.6);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-blue: #3b82f6;
            --accent-amber: #f59e0b;
            --accent-red: #ef4444;
            --border-color: rgba(255, 255, 255, 0.08);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            background-image: 
                radial-gradient(circle at 0% 0%, rgba(59, 130, 246, 0.15), transparent 40%),
                radial-gradient(circle at 100% 100%, rgba(139, 92, 246, 0.15), transparent 40%);
        }

        /* --- Mobile Header --- */
        .mobile-header {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            z-index: 50;
            align-items: center; padding: 0 20px; justify-content: space-between;
        }
        .hamburger-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }

        /* --- Sidebar --- */
        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 20px;
            backdrop-filter: blur(20px);
            z-index: 60;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .brand {
            font-size: 1.2rem; font-weight: 800; color: white; 
            margin-bottom: 20px; display: flex; align-items: center; gap: 10px;
            text-decoration: none;
        }

        .home-link {
            display: flex; align-items: center; gap: 10px;
            padding: 12px 16px; margin-bottom: 20px;
            background: rgba(255,255,255,0.05); border: 1px solid var(--border-color);
            border-radius: 8px; color: var(--text-primary); text-decoration: none;
            font-weight: 600; transition: 0.2s;
        }
        .home-link:hover { background: rgba(255,255,255,0.1); border-color: var(--accent-blue); }

        .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .menu-label { font-size: 0.75rem; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 1px; font-weight: 600; }
        .add-cat-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.2rem; line-height: 1; padding: 0 5px; transition: 0.2s; }
        .add-cat-btn:hover { color: white; transform: scale(1.2); }
        
        .nav-item {
            padding: 12px 16px; margin-bottom: 5px; border-radius: 8px; cursor: pointer;
            color: var(--text-secondary); font-size: 0.95rem; transition: all 0.2s;
            display: flex; justify-content: space-between; align-items: center; position: relative;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { background: rgba(59, 130, 246, 0.15); color: var(--accent-blue); font-weight: 600; }
        
        .cat-delete-btn { opacity: 0; color: var(--text-secondary); font-size: 0.9rem; padding: 4px; transition: 0.2s; cursor: pointer; margin-left: auto; margin-right: 5px; }
        .cat-delete-btn:hover { color: var(--accent-red); opacity: 1 !important; }
        .nav-item:hover .cat-delete-btn { opacity: 0.5; }
        .count-badge { background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; }

        .year-progress-container { margin-top: auto; margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid var(--border-color); }
        .progress-label { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600; }
        .progress-track { width: 100%; height: 6px; background: rgba(0,0,0,0.3); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #3b82f6, #8b5cf6); width: 0%; transition: width 1.5s cubic-bezier(0.22, 1, 0.36, 1); }

        .sidebar-footer { border-top: 1px solid var(--border-color); padding-top: 20px; }
        .tool-btn { width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .tool-btn:hover { background: rgba(255,255,255,0.1); color: white; }

        /* --- Main Content --- */
        .main-content { flex: 1; padding: 30px 40px; overflow-y: auto; position: relative; }
        .hero-section { margin-bottom: 40px; animation: fadeIn 0.5s ease; }
        .hero-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.95)); background-size: 200% 200%;
            border: 1px solid var(--border-color); border-radius: 20px; padding: 40px;
            position: relative; overflow: hidden; box-shadow: 0 20px 50px -20px rgba(0,0,0,0.5); transition: all 0.5s ease;
        }
        @keyframes aurora-flow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .hero-card.flow-mode { animation: aurora-flow 15s ease infinite; }
        @keyframes pulse-urgent { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); border-color: rgba(239, 68, 68, 0.6); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); border-color: rgba(239, 68, 68, 1); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); border-color: rgba(239, 68, 68, 0.6); } }
        .hero-card.urgent-mode { background: linear-gradient(135deg, rgba(60, 20, 20, 0.95), rgba(30, 10, 10, 0.98)); animation: pulse-urgent 2s infinite; }
        
        .hero-bg-icon { position: absolute; right: -20px; bottom: -20px; font-size: 10rem; opacity: 0.05; transform: rotate(-15deg); pointer-events: none; }
        .hero-meta { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .category-tag { padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        .hero-title { font-size: 2.5rem; font-weight: 800; color: white; margin-bottom: 10px; }
        .hero-count { font-family: 'JetBrains Mono'; font-size: 5rem; font-weight: 700; line-height: 1; margin: 20px 0; text-shadow: 0 0 30px rgba(255,255,255,0.1); }
        .hero-date { color: var(--text-secondary); font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }

        .grid-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .add-btn { background: var(--accent-blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); transition: 0.2s; }
        .add-btn:hover { transform: translateY(-2px); }

        .days-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding-bottom: 40px; }
        
        .day-card {
            background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 16px; padding: 20px;
            position: relative; transition: all 0.3s; display: flex; flex-direction: column; height: 160px; 
            backdrop-filter: blur(10px); overflow: hidden;
        }
        .day-card:hover { transform: translateY(-5px); border-color: rgba(255,255,255,0.2); box-shadow: 0 10px 30px -10px rgba(0,0,0,0.3); }
        
        /* Content Layer */
        .card-content-layer {
            transition: 0.3s ease; filter: blur(0); opacity: 1;
            height: 100%; display: flex; flex-direction: column;
        }
        
        /* Note Overlay */
        .card-note-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95);
            display: flex; align-items: center; justify-content: center;
            padding: 20px; opacity: 0; pointer-events: none; transform: scale(1.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 5;
        }
        
        /* Note Text Fix */
        .note-text {
            color: var(--text-primary); font-size: 0.95rem; line-height: 1.6;
            text-align: center; 
            white-space: pre-wrap;       
            word-wrap: break-word;       
            word-break: break-word;      
            overflow-wrap: break-word;   
            max-height: 100%; overflow-y: auto; width: 100%;
        }

        .day-card.show-note .card-content-layer { filter: blur(5px); opacity: 0.3; }
        .day-card.show-note .card-note-overlay { opacity: 1; pointer-events: auto; transform: scale(1); }

        /* Card Header & Tools */
        .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: auto; }
        .card-title-group { display: flex; flex-direction: column; gap: 4px; }
        .card-title { font-weight: 600; font-size: 1.1rem; color: var(--text-primary); }
        .card-icon { font-size: 1rem; opacity: 0.7; }

        /* Unified Control Hub */
        .card-tools {
            display: flex; gap: 4px; background: rgba(255,255,255,0.05);
            padding: 4px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05);
            transition: 0.2s;
        }
        .day-card:hover .card-tools { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.1); }
        
        .tool-icon {
            background: none; border: none; color: var(--text-secondary);
            cursor: pointer; font-size: 0.9rem; padding: 6px; border-radius: 50%;
            transition: all 0.2s; opacity: 0.6; display: flex; align-items: center; justify-content: center;
        }
        .tool-icon:hover { background: rgba(255,255,255,0.1); color: white; opacity: 1; transform: scale(1.1); }
        
        .tool-icon.active-pin { color: #fff; opacity: 1; text-shadow: 0 0 8px rgba(255,255,255,0.5); }
        .tool-icon.has-note { color: var(--accent-amber); opacity: 1; }
        .tool-icon.has-note:hover { color: #fff; text-shadow: 0 0 8px var(--accent-amber); }

        .card-middle { display: flex; align-items: baseline; gap: 8px; }
        .card-num { font-family: 'JetBrains Mono'; font-size: 2.2rem; font-weight: 700; }
        .card-label { font-size: 0.85rem; color: var(--text-secondary); }
        .card-bottom { margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-secondary); }
        
        .delete-btn { cursor: pointer; color: var(--text-secondary); transition: 0.2s; font-size: 0.8rem; opacity: 0; }
        .day-card:hover .delete-btn { opacity: 1; }
        .delete-btn:hover { color: var(--accent-red); }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal-overlay.open { display: flex; }
        .modal-box { background: #1e293b; border: 1px solid var(--border-color); width: 400px; padding: 30px; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto; }
        
        .input-group { margin-bottom: 15px; }
        .input-label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.9rem; }
        .input-field { width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); color: white; border-radius: 8px; outline: none; font-family: 'Inter'; }
        .input-field:focus { border-color: var(--accent-blue); }
        textarea.input-field { resize: vertical; min-height: 80px; }

        .category-select { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .cat-opt { padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border-color); cursor: pointer; font-size: 0.85rem; color: var(--text-secondary); transition: 0.2s; display: flex; align-items: center; gap: 5px; }
        .cat-opt.selected { background: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; cursor: pointer; margin-top: 5px; }
        .checkbox-wrapper input { width: 16px; height: 16px; accent-color: var(--accent-blue); cursor: pointer; }
        .checkbox-label { color: var(--text-secondary); font-size: 0.9rem; }
        .grid-picker { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-top: 10px; }
        .picker-item { height: 40px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.05); border-radius: 8px; cursor: pointer; border: 1px solid transparent; transition: 0.2s; font-size: 1.2rem; }
        .picker-item:hover { background: rgba(255,255,255,0.1); }
        .picker-item.selected { border-color: var(--accent-blue); background: rgba(59, 130, 246, 0.2); }
        .color-dot { width: 20px; height: 20px; border-radius: 50%; }
        #calc-result { margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; text-align: center; display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .pinned-badge { position: absolute; top: 20px; right: 20px; font-size: 1.5rem; transform: rotate(-45deg); filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }

        .help-list { list-style: none; padding: 0; }
        .help-list li { margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 10px; }
        .help-list strong { color: white; display: block; margin-bottom: 5px; }
        .help-list span { color: var(--text-secondary); font-size: 0.9rem; line-height: 1.4; }

        .mobile-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); z-index: 55; }

        @media (max-width: 768px) {
            .mobile-header { display: flex; }
            .sidebar { position: fixed; left: 0; top: 0; height: 100vh; transform: translateX(-100%); width: 280px; padding-top: 80px; }
            .sidebar.open { transform: translateX(0); }
            .mobile-overlay.open { display: block; }
            .main-content { padding: 80px 20px 20px 20px; }
            .hero-count { font-size: 3.5rem; }
            .delete-btn { opacity: 1; }
            .sidebar .brand { position: absolute; top: 20px; left: 20px; margin: 0; }
            .cat-delete-btn { opacity: 0.7; padding: 10px; }
        }
    </style>
</head>
<body>

    <!-- Mobile Header -->
    <header class="mobile-header">
        <div style="font-weight: 800; color: white; font-size: 1.1rem;">‚ö° FlowState</div>
        <button class="hamburger-btn" onclick="toggleSidebar()">‚ò∞</button>
    </header>

    <div class="mobile-overlay" id="mobile-overlay" onclick="toggleSidebar()"></div>

    <!-- 1. Sidebar -->
    <aside class="sidebar" id="sidebar">
        <!-- BRAND -->
        <a href="index.html" class="brand">
            ‚ö° FlowState <span style="font-weight: 400; opacity: 0.6;">Days</span>
        </a>
        <a href="index.html" class="home-link"><span>üè† Back to Home</span></a>

        <div class="sidebar-header">
            <div class="menu-label">Categories</div>
            <button class="add-cat-btn" onclick="openCatModal()" title="Add Category">+</button>
        </div>
        
        <div id="sidebar-list"></div>

        <div class="year-progress-container">
            <div class="progress-label">
                <span>Year Progress</span>
                <span id="year-percent">0%</span>
            </div>
            <div class="progress-track">
                <div class="progress-fill" id="year-fill"></div>
            </div>
        </div>

        <div class="sidebar-footer">
            <button class="tool-btn" onclick="openHelpModal()" style="margin-bottom: 10px;"><span>‚ùì</span> Help & Guide</button>
            <button class="tool-btn" onclick="openCalcModal()" style="margin-bottom: 10px;"><span>üßÆ</span> Date Calculator</button>
            <div style="display: flex; gap: 10px;">
                <button class="tool-btn" onclick="exportData()" title="Backup Data"><span>‚¨áÔ∏è</span> Backup</button>
                <button class="tool-btn" onclick="document.getElementById('import-file').click()" title="Restore Data"><span>‚¨ÜÔ∏è</span> Restore</button>
            </div>
            <input type="file" id="import-file" style="display: none" onchange="importData(this)">
        </div>
    </aside>

    <!-- 2. Main Dashboard -->
    <main class="main-content">
        <div id="hero-container" class="hero-section"></div>
        <div class="grid-header">
            <h2 style="font-size: 1.2rem; color: white;">Timeline</h2>
            <button class="add-btn" onclick="openAddModal()">+ New Event</button>
        </div>
        <div id="days-grid" class="days-grid"></div>
    </main>

    <!-- Modals -->
    <!-- Add/Edit Event -->
    <div class="modal-overlay" id="add-modal">
        <div class="modal-box">
            <h3 style="color: white; margin-bottom: 20px;" id="modal-title">Add New Event</h3>
            <input type="hidden" id="evt-id">
            <div class="input-group">
                <label class="input-label">Event Title</label>
                <input type="text" id="evt-title" class="input-field" placeholder="e.g. Project Launch">
            </div>
            <div class="input-group">
                <label class="input-label">Date</label>
                <input type="date" id="evt-date" class="input-field">
            </div>
            <div class="input-group">
                <label class="input-label">Memo / Notes</label>
                <textarea id="evt-note" class="input-field" rows="3" placeholder="e.g. Buy flowers, Submit report via email..."></textarea>
            </div>
            <!-- REPEAT SELECTOR -->
            <div class="input-group">
                <label class="input-label">Repeat Cycle</label>
                <select id="evt-loop-mode" class="input-field" style="appearance: auto; cursor: pointer;">
                    <option value="0">No Repeat</option>
                    <option value="1">Every Month</option>
                    <option value="2">Every 2 Months</option>
                    <option value="3">Every 3 Months (Quarterly)</option>
                    <option value="4">Every 4 Months</option>
                    <option value="5">Every 5 Months</option>
                    <option value="6">Every 6 Months (Half Year)</option>
                    <option value="7">Every 7 Months</option>
                    <option value="8">Every 8 Months</option>
                    <option value="9">Every 9 Months</option>
                    <option value="10">Every 10 Months</option>
                    <option value="11">Every 11 Months</option>
                    <option value="12">Every Year (Annually)</option>
                </select>
            </div>
            <div class="input-group">
                <label class="input-label">Category</label>
                <div class="category-select" id="cat-select-container"></div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button class="add-btn" style="flex: 1;" onclick="saveEvent()">Save</button>
                <button class="tool-btn" style="flex: 1;" onclick="closeModals()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add Category -->
    <div class="modal-overlay" id="cat-modal">
        <div class="modal-box">
            <h3 style="color: white; margin-bottom: 20px;">Create Category</h3>
            <div class="input-group">
                <label class="input-label">Category Name</label>
                <input type="text" id="new-cat-name" class="input-field" placeholder="e.g. Gaming">
            </div>
            <div class="input-group">
                <label class="input-label">Select Icon</label>
                <div class="grid-picker" id="icon-picker"></div>
            </div>
            <div class="input-group">
                <label class="input-label">Select Color</label>
                <div class="grid-picker" id="color-picker"></div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button class="add-btn" style="flex: 1;" onclick="saveCategory()">Create</button>
                <button class="tool-btn" style="flex: 1;" onclick="closeModals()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Date Calculator -->
    <div class="modal-overlay" id="calc-modal">
        <div class="modal-box">
            <h3 style="color: white; margin-bottom: 20px;">üìÖ Date Calculator</h3>
            <div class="input-group">
                <label class="input-label">Start Date</label>
                <input type="date" id="calc-start" class="input-field">
            </div>
            <div class="input-group">
                <label class="input-label">Days to Add/Subtract</label>
                <input type="number" id="calc-days" class="input-field" placeholder="e.g. 100 or -50">
            </div>
            <button class="add-btn" style="width: 100%;" onclick="calculateDate()">Calculate</button>
            <div id="calc-result">
                <span style="color: var(--text-secondary); font-size: 0.9rem;">Result:</span>
                <div style="color: var(--accent-blue); font-size: 1.5rem; font-weight: bold; margin-top: 5px;" id="calc-res-text">--</div>
            </div>
            <button class="tool-btn" style="width: 100%; margin-top: 15px;" onclick="closeModals()">Close</button>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal-overlay" id="help-modal">
        <div class="modal-box">
            <h3 style="color: white; margin-bottom: 20px;">üìñ User Guide</h3>
            <ul class="help-list">
                <li><strong>üìù Memo</strong><span>If a card has a note, a yellow icon appears. Click it to view. No note = No icon.</span></li>
                <li><strong>üìå Pin Event</strong><span>Click the pin icon to feature an event at the top.</span></li>
                <li><strong>üîÑ Repeat</strong><span>Set events to repeat Monthly, Quarterly, or Annually.</span></li>
                <li><strong>‚úèÔ∏è Edit</strong><span>Click the pencil icon to modify details or add a note.</span></li>
                <li><strong>üíæ Backup</strong><span>Download your data as JSON and restore it on any device.</span></li>
            </ul>
            <button class="tool-btn" style="width: 100%;" onclick="closeModals()">Got it!</button>
        </div>
    </div>

    <script>
        // --- Data & State ---
        let categories = JSON.parse(localStorage.getItem('fs_categories')) || [
            { id: 'Life', label: 'Life', icon: 'üåø', color: '#10b981' },
            { id: 'Work', label: 'Work', icon: 'üíº', color: '#3b82f6' },
            { id: 'Anniversary', label: 'Love', icon: '‚ù§Ô∏è', color: '#ef4444' }
        ];

        let events = JSON.parse(localStorage.getItem('fs_events')) || [
            { id: 1, title: 'Google Founded', date: '1998-09-04', category: 'Anniversary', isPinned: false, loopMode: "12", note: 'Search engine revolution starts here.' },
            { id: 2, title: 'New Year 2026', date: '2026-01-01', category: 'Life', isPinned: false, loopMode: "0", note: 'Buy champagne and fireworks! üéÜ' },
            { id: 3, title: 'Project Deadline', date: '2026-03-15', category: 'Work', isPinned: false, loopMode: "0", note: 'Final submission due.' }
        ];

        let currentFilter = 'All';
        let tempCategory = 'Life'; 
        let tempIcon = '‚ö°'; 
        let tempColor = '#3b82f6'; 

        const iconOptions = ['‚ö°', 'üéì', '‚úàÔ∏è', 'üè†', 'üí∞', 'üéÆ', 'üèãÔ∏è', 'üé®', 'üéµ', 'üíä', 'üçî', 'üê∂'];
        const colorOptions = ['#3b82f6', '#10b981', '#ef4444', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#6366f1'];

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('evt-date').valueAsDate = new Date();
            document.getElementById('calc-start').valueAsDate = new Date();
            updateYearProgress();
            renderSidebar();
            initPickers();
            render();
        });

        // --- Core Logic ---
        function getDisplayDate(event) {
            const now = new Date(); now.setHours(0,0,0,0);
            let target = new Date(event.date); target.setHours(0,0,0,0);
            
            // Get interval (default 0)
            let interval = parseInt(event.loopMode);
            if (isNaN(interval)) {
                interval = event.isLoop ? 12 : 0;
            }

            // No repeat
            if (interval === 0) return target;

            // If date is past, add interval months until future
            while (target < now) {
                target.setMonth(target.getMonth() + interval);
            }
            
            return target;
        }

        function getDiff(event) {
            const now = new Date(); now.setHours(0,0,0,0);
            const target = getDisplayDate(event);
            return Math.ceil((target - now) / (1000 * 60 * 60 * 24));
        }

        function getCatConfig(catId) {
            return categories.find(c => c.id === catId) || { color: '#94a3b8', icon: 'üìÖ', label: catId };
        }

        // --- Render UI ---
        function renderSidebar() {
            const list = document.getElementById('sidebar-list');
            let html = `
                <div class="nav-item ${currentFilter === 'All' ? 'active' : ''}" onclick="filterCategory('All')">
                    <span>üåç All Days</span>
                    <span class="count-badge">${events.length}</span>
                </div>
            `;
            categories.forEach(cat => {
                const count = events.filter(e => e.category === cat.id).length;
                const isActive = currentFilter === cat.id ? 'active' : '';
                const isDeletable = cat.id !== 'Life'; 
                const deleteBtn = isDeletable ? `<span class="cat-delete-btn" onclick="deleteCategory(event, '${cat.id}')" title="Delete Category">üóëÔ∏è</span>` : '';
                html += `
                    <div class="nav-item ${isActive}" onclick="filterCategory('${cat.id}')">
                        <div style="display:flex; align-items:center; gap:8px;"><span>${cat.icon} ${cat.label}</span></div>
                        <div style="display:flex; align-items:center;">${deleteBtn}<span class="count-badge">${count}</span></div>
                    </div>
                `;
            });
            list.innerHTML = html;
        }

        function render() {
            let filtered = currentFilter === 'All' ? events : events.filter(e => e.category === currentFilter);
            filtered.sort((a, b) => {
                const da = getDiff(a), db = getDiff(b);
                if (da >= 0 && db >= 0) return da - db;
                if (da < 0 && db < 0) return db - da; 
                return db - da; 
            });

            let heroEvent = filtered.find(e => e.isPinned) || filtered[0];
            const heroContainer = document.getElementById('hero-container');
            
            if (heroEvent) {
                const diff = getDiff(heroEvent);
                const isPast = diff < 0;
                const conf = getCatConfig(heroEvent.category);
                const pinBadge = heroEvent.isPinned ? `<div class="pinned-badge">üìå</div>` : '';
                const displayDate = getDisplayDate(heroEvent);
                let animClass = (diff >= 0 && diff <= 3) ? 'urgent-mode' : 'flow-mode';
                
                // Hero Loop Icon Logic
                let hInterval = parseInt(heroEvent.loopMode);
                if (isNaN(hInterval)) hInterval = heroEvent.isLoop ? 12 : 0;
                let loopIcon = hInterval > 0 ? 'üîÑ ' : '';

                heroContainer.innerHTML = `
                    <div class="hero-card ${animClass}" style="border-top: 4px solid ${conf.color}">
                        ${pinBadge}
                        <div class="hero-bg-icon">${conf.icon}</div>
                        <div class="hero-meta">
                            <span class="category-tag" style="background: ${conf.color}20; color: ${conf.color}">${conf.icon} ${conf.label}</span>
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">${heroEvent.isPinned ? 'Pinned' : (isPast ? 'Memories' : 'Upcoming')}</span>
                        </div>
                        <div class="hero-title">${loopIcon}${heroEvent.title}</div>
                        <div class="hero-count" style="color: ${isPast ? '#94a3b8' : conf.color}">${Math.abs(diff)}<span style="font-size: 1.5rem; margin-left:10px;">Days ${isPast ? 'Ago' : 'Left'}</span></div>
                        <div class="hero-date">üìÖ ${displayDate.toLocaleDateString()}</div>
                    </div>
                `;
            } else {
                heroContainer.innerHTML = `<div class="hero-card" style="text-align:center; color:#64748b; padding:60px;">No events found.</div>`;
            }

            document.getElementById('days-grid').innerHTML = filtered.map(e => {
                const diff = getDiff(e);
                const isPast = diff < 0;
                const conf = getCatConfig(e.category);
                const displayDate = getDisplayDate(e);
                
                // Card Loop Icon Logic
                let interval = parseInt(e.loopMode);
                if (isNaN(interval)) interval = e.isLoop ? 12 : 0;
                const loopIcon = interval > 0 ? '<span title="Recurring">üîÑ</span>' : '';
                
                const hasNote = e.note && e.note.trim().length > 0;
                const noteBtn = hasNote 
                    ? `<button class="tool-icon has-note" onclick="toggleNote(this)" title="View Note">üìù</button>` 
                    : ''; 
                
                const noteOverlay = hasNote 
                    ? `<div class="card-note-overlay" onclick="toggleNote(this.parentElement)"><div class="note-text">${e.note}</div></div>` 
                    : '';
                
                const pinClass = e.isPinned ? 'active-pin' : '';

                return `
                    <div class="day-card">
                        ${noteOverlay}
                        <div class="card-content-layer">
                            <div class="card-top">
                                <div class="card-title-group">
                                    <div class="card-title">${e.title}</div>
                                    <div class="card-icon">${conf.icon}</div>
                                </div>
                                
                                <div class="card-tools">
                                    ${noteBtn}
                                    <button class="tool-icon ${pinClass}" onclick="togglePin(${e.id})" title="Pin">üìå</button>
                                    <button class="tool-icon" onclick="openEditModal(${e.id})" title="Edit">‚úèÔ∏è</button>
                                </div>
                            </div>
                            
                            <div class="card-middle">
                                <div class="card-num" style="color: ${isPast ? '#94a3b8' : conf.color}">${Math.abs(diff)}</div>
                                <div class="card-label">${isPast ? 'days ago' : 'days left'}</div>
                            </div>
                            
                            <div class="card-bottom">
                                <div style="display:flex; align-items:center; gap:5px;">${loopIcon}<span>${displayDate.toLocaleDateString()}</span></div>
                                <span class="delete-btn" onclick="deleteEvent(${e.id})">Delete</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            renderSidebar();
        }

        // --- Functions ---
        function toggleNote(el) {
            const card = el.closest('.day-card');
            card.classList.toggle('show-note');
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            sb.classList.toggle('open');
            overlay.classList.toggle('open');
        }

        function deleteCategory(e, id) {
            e.stopPropagation();
            if(id === 'Life') return alert('Cannot delete default category.');
            const count = events.filter(ev => ev.category === id).length;
            if(confirm(`Delete category "${id}"? \n${count} events will be moved to "Life".`)) {
                events = events.map(ev => ev.category === id ? { ...ev, category: 'Life' } : ev);
                categories = categories.filter(c => c.id !== id);
                localStorage.setItem('fs_events', JSON.stringify(events));
                localStorage.setItem('fs_categories', JSON.stringify(categories));
                if(currentFilter === id) currentFilter = 'All';
                renderSidebar(); render();
            }
        }

        function saveCategory() {
            const name = document.getElementById('new-cat-name').value.trim();
            if(!name) return alert('Please enter a category name');
            if(categories.find(c => c.id === name)) return alert('Category already exists');
            categories.push({ id: name, label: name, icon: tempIcon, color: tempColor });
            localStorage.setItem('fs_categories', JSON.stringify(categories));
            closeModals(); renderSidebar(); render();
            document.getElementById('new-cat-name').value = '';
        }

        function saveEvent() {
            const id = document.getElementById('evt-id').value;
            const title = document.getElementById('evt-title').value;
            const date = document.getElementById('evt-date').value;
            const note = document.getElementById('evt-note').value;
            const loopMode = document.getElementById('evt-loop-mode').value; 

            if(!title || !date) return alert('Please fill all fields');
            
            if (id) {
                const index = events.findIndex(e => e.id == id);
                if (index !== -1) events[index] = { ...events[index], title, date, category: tempCategory, loopMode, note };
            } else {
                events.push({ id: Date.now(), title, date, category: tempCategory, isPinned: false, loopMode, note });
            }
            localStorage.setItem('fs_events', JSON.stringify(events));
            closeModals(); render();
        }

        function deleteEvent(id) {
            if(confirm('Delete this event?')) {
                events = events.filter(e => e.id !== id);
                localStorage.setItem('fs_events', JSON.stringify(events));
                render();
            }
        }

        function togglePin(id) {
            events = events.map(e => ({ ...e, isPinned: e.id === id ? !e.isPinned : false }));
            localStorage.setItem('fs_events', JSON.stringify(events));
            render();
        }

        function filterCategory(cat) {
            currentFilter = cat;
            if(window.innerWidth <= 768) toggleSidebar();
            render();
        }

        function initPickers() {
            const iconHTML = iconOptions.map(icon => `<div class="picker-item" onclick="selectPicker(this, 'icon', '${icon}')">${icon}</div>`).join('');
            document.getElementById('icon-picker').innerHTML = iconHTML;
            const colorHTML = colorOptions.map(color => `<div class="picker-item" onclick="selectPicker(this, 'color', '${color}')"><div class="color-dot" style="background:${color}"></div></div>`).join('');
            document.getElementById('color-picker').innerHTML = colorHTML;
        }

        function selectPicker(el, type, value) {
            const parent = el.parentElement;
            parent.querySelectorAll('.picker-item').forEach(i => i.classList.remove('selected'));
            el.classList.add('selected');
            if(type === 'icon') tempIcon = value;
            if(type === 'color') tempColor = value;
        }

        function updateYearProgress() {
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 0);
            const percent = ((now - start) / (1000 * 60 * 60 * 24 * 365) * 100).toFixed(1);
            document.getElementById('year-fill').style.width = percent + '%';
            document.getElementById('year-percent').innerText = percent + '%';
        }

        function exportData() {
            const data = { events, categories };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `flowstate_backup.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (Array.isArray(json)) { events = json; } 
                    else if (json.events && json.categories) { events = json.events; categories = json.categories; localStorage.setItem('fs_categories', JSON.stringify(categories)); }
                    localStorage.setItem('fs_events', JSON.stringify(events));
                    renderSidebar(); render(); alert('Data restored!');
                } catch (err) { alert('Invalid backup file'); }
            };
            reader.readAsText(file); input.value = '';
        }

        function calculateDate() {
            const start = document.getElementById('calc-start').value;
            const days = parseInt(document.getElementById('calc-days').value);
            if(!start || isNaN(days)) return;
            const d = new Date(start); d.setDate(d.getDate() + days);
            document.getElementById('calc-res-text').innerText = d.toLocaleDateString();
            document.getElementById('calc-result').style.display = 'block';
        }

        function openAddModal() {
            document.getElementById('modal-title').innerText = "Add New Event";
            document.getElementById('evt-id').value = "";
            document.getElementById('evt-title').value = "";
            document.getElementById('evt-date').valueAsDate = new Date();
            document.getElementById('evt-note').value = ""; 
            document.getElementById('evt-loop-mode').value = "0"; // Reset to None
            renderCatSelect(categories[0].id);
            document.getElementById('add-modal').classList.add('open');
        }

        function openEditModal(id) {
            const e = events.find(x => x.id === id);
            if (!e) return;
            document.getElementById('modal-title').innerText = "Edit Event";
            document.getElementById('evt-id').value = e.id;
            document.getElementById('evt-title').value = e.title;
            document.getElementById('evt-date').value = e.date;
            document.getElementById('evt-note').value = e.note || ""; 
            
            // Compatibility check
            let mode = e.loopMode;
            if (mode === undefined || mode === null) {
                mode = e.isLoop ? "12" : "0";
            }
            document.getElementById('evt-loop-mode').value = mode;

            renderCatSelect(e.category);
            document.getElementById('add-modal').classList.add('open');
        }

        function renderCatSelect(selectedId) {
            const container = document.getElementById('cat-select-container');
            container.innerHTML = categories.map(cat => `
                <div class="cat-opt ${cat.id === selectedId ? 'selected' : ''}" onclick="selectCat(this, '${cat.id}')">
                    ${cat.icon} ${cat.label}
                </div>
            `).join('');
            tempCategory = selectedId;
        }

        function selectCat(el, catId) {
            document.querySelectorAll('.cat-opt').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
            tempCategory = catId;
        }

        function openCatModal() { document.getElementById('cat-modal').classList.add('open'); }
        function openCalcModal() { document.getElementById('calc-modal').classList.add('open'); }
        function openHelpModal() { document.getElementById('help-modal').classList.add('open'); }
        function closeModals() { 
            document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('open'));
            document.getElementById('calc-result').style.display = 'none';
        }
        window.onclick = function(e) { if (e.target.classList.contains('modal-overlay')) closeModals(); }
    </script>
</body>
</html>
