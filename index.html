<!DOCTYPE html>
<html lang="en">
<head>
	<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9X5EY2TKFD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-9X5EY2TKFD');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowState | Focus Timer & Nature Sounds</title>
	<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2928/2928750.png">

    
    <!-- External Resources -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --border-color: rgba(255, 255, 255, 0.1);
            --nav-height: 60px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* --- Navbar --- */
        .navbar {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--nav-height);
            background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color); z-index: 1000;
            display: flex; justify-content: center;
        }
        .nav-content {
            width: 100%; max-width: 1200px; padding: 0 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .logo { font-weight: 800; font-size: 1.2rem; color: white; text-decoration: none; display: flex; align-items: center; gap: 8px; }
        .nav-links a { color: var(--text-secondary); text-decoration: none; margin-left: 20px; font-size: 0.9rem; transition: color 0.3s; }
        .nav-links a:hover { color: white; }

        /* --- Main Layout --- */
        .main-wrapper {
            margin-top: var(--nav-height);
            display: flex; flex-direction: column; align-items: center;
        }

        /* --- Hero Section --- */
        .hero-section {
            width: 100%;
            padding: 40px 20px 20px 20px;
            background: radial-gradient(circle at 50% 0%, rgba(59, 130, 246, 0.15), transparent 50%);
            display: flex; justify-content: center;
        }
        
        .app-container {
            width: 100%; max-width: 1200px;
            display: grid; grid-template-columns: 350px 1fr; gap: 20px;
        }
        .card {
            background: var(--card-bg); backdrop-filter: blur(10px);
            border: 1px solid var(--border-color); border-radius: 16px;
            padding: 24px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            display: flex; flex-direction: column;
        }
        h2 { font-size: 1.1rem; margin-bottom: 15px; color: var(--text-secondary); font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        
        /* Timer Styles */
        .timer-display { 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 4rem; 
            font-weight: 700; 
            text-align: center; 
            margin: 10px 0; 
            text-shadow: 0 0 20px rgba(59, 130, 246, 0.3); 
            font-variant-numeric: tabular-nums; 
            transition: color 0.3s, text-shadow 0.3s;
        }

        @keyframes flash-red-text {
            0% { color: var(--accent-red); text-shadow: 0 0 10px var(--accent-red); opacity: 1; }
            50% { color: var(--accent-red); text-shadow: 0 0 30px var(--accent-red); opacity: 0.5; }
            100% { color: var(--accent-red); text-shadow: 0 0 10px var(--accent-red); opacity: 1; }
        }
        .timer-finished {
            animation: flash-red-text 1.5s infinite ease-in-out;
            color: var(--accent-red) !important;
        }

        /* Controls */
        .mode-switch { display: flex; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 4px; margin-bottom: 15px; }
        .mode-btn { flex: 1; background: transparent; border: none; color: var(--text-secondary); padding: 8px; cursor: pointer; border-radius: 6px; transition: all 0.3s; }
        .mode-btn.active { background: var(--accent-blue); color: white; }
        .mode-btn:hover:not(.active) { color: white; background: rgba(255,255,255,0.05); }
        
        .project-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .project-select { flex: 1; padding: 12px; background: rgba(0,0,0,0.2); border: 1px solid var(--border-color); color: white; border-radius: 8px; outline: none; }
        .icon-btn { width: 42px; background: rgba(0,0,0,0.2); border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 8px; cursor: pointer; font-size: 1.2rem; }
        .icon-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; color: #fff; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-start { background: var(--accent-green); }
        .btn-stop { background: var(--accent-red); }
        .btn-reset { background: var(--text-secondary); }

        /* Sound Bar */
        .sound-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 12px;
            margin: 10px 0;
            border: 1px solid var(--border-color);
        }
        .sound-icons { display: flex; gap: 8px; }
        .sound-btn {
            background: transparent;
            border: 1px solid transparent;
            font-size: 1.2rem;
            width: 36px; height: 36px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .sound-btn:hover { background: rgba(255,255,255,0.1); }
        .sound-btn.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: var(--accent-blue);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.2);
        }
        .volume-slider {
            width: 60px;
            accent-color: var(--accent-blue);
            cursor: pointer;
        }
        
        /* Logs & Charts */
        .log-list { flex: 1; overflow-y: auto; margin-top: 10px; padding-right: 5px; max-height: 250px; }
        .log-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; color: var(--text-secondary); }
        .delete-btn { color: var(--accent-red); cursor: pointer; border: none; background: none; padding: 0 5px; }
        
        .dashboard-grid { display: grid; grid-template-rows: auto 1fr; gap: 20px; }
        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .chart-container { position: relative; height: 250px; width: 100%; }
        
        /* --- Advanced Stats Styles --- */
        .adv-stats-section {
            width: 100%;
            max-width: 1200px;
            padding: 0 20px 40px 20px;
        }
        .adv-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .adv-grid {
            display: grid;
            grid-template-columns: 1fr 2fr; /* Pie takes 1, Bar takes 2 */
            gap: 20px;
        }
        
        /* Date Navigator Styles */
        .date-navigator-wrapper { display: flex; align-items: center; background: rgba(255,255,255,0.05); padding: 4px; border-radius: 8px; border: 1px solid var(--border-color); height: 38px; }
        .nav-arrow { background: transparent; border: none; color: var(--text-secondary); cursor: pointer; padding: 0 10px; font-size: 0.8rem; height: 100%; border-radius: 4px; }
        .nav-arrow:hover { background: rgba(255,255,255,0.1); color: white; }
        
        .date-picker-container { position: relative; height: 100%; display: flex; align-items: center; justify-content: center; min-width: 140px; cursor: pointer; border-radius: 4px; }
        .date-picker-container:hover { background: rgba(255,255,255,0.05); }
        
        .date-label-group { display: flex; align-items: center; gap: 6px; color: var(--text-primary); font-size: 0.9rem; font-weight: 500; pointer-events: none; }
        
        /* Invisible Date Input */
        #adv-date-picker { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; }

        .scroll-container {
            overflow-x: auto;
            padding-bottom: 5px;
        }
        .scroll-container::-webkit-scrollbar { height: 4px; }
        .scroll-container::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-overlay.open { display: flex; }
        .modal-content { background: #1e293b; border: 1px solid var(--border-color); width: 400px; max-width: 90%; border-radius: 16px; padding: 24px; }
        .add-form { display: flex; gap: 10px; margin-bottom: 20px; }
        .input-text { flex: 1; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); color: white; border-radius: 6px; }
        .input-color { width: 40px; height: 38px; border: none; background: none; cursor: pointer; }
        .project-list-item { display: flex; justify-content: space-between; padding: 8px; background: rgba(255,255,255,0.05); margin-bottom: 5px; border-radius: 4px; align-items: center; }

        /* SEO Content */
        .seo-wrapper { width: 100%; background: #0b1120; border-top: 1px solid var(--border-color); padding: 80px 20px; display: flex; justify-content: center; }
        .seo-content { width: 100%; max-width: 1000px; }
        .section-header { text-align: center; margin-bottom: 60px; }
        .section-title { font-size: 2.5rem; font-weight: 800; margin-bottom: 20px; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; line-height: 1.2; }
        .section-subtitle { font-size: 1.1rem; color: var(--text-secondary); max-width: 600px; margin: 0 auto; }
        .features-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-bottom: 80px; }
        .feature-card { background: rgba(30, 41, 59, 0.4); border: 1px solid var(--border-color); padding: 30px; border-radius: 16px; transition: transform 0.3s; }
        .feature-card:hover { transform: translateY(-5px); border-color: var(--accent-blue); }
        .f-icon { font-size: 2.5rem; margin-bottom: 20px; display: block; }
        .f-title { font-size: 1.3rem; font-weight: 700; color: white; margin-bottom: 10px; }
        .f-desc { color: var(--text-secondary); font-size: 0.95rem; line-height: 1.7; }
        .faq-section { margin-top: 60px; }
        .faq-item { border-bottom: 1px solid var(--border-color); padding: 20px 0; }
        .faq-question { font-size: 1.1rem; font-weight: 600; color: white; margin-bottom: 10px; }
        .faq-answer { color: var(--text-secondary); font-size: 0.95rem; line-height: 1.6; }
        footer { width: 100%; padding: 40px 20px; border-top: 1px solid var(--border-color); text-align: center; color: var(--text-secondary); font-size: 0.9rem; background: #0f172a; }

        @media (max-width: 768px) {
            .app-container { grid-template-columns: 1fr; }
            .stats-row { grid-template-columns: 1fr; }
            .timer-display { font-size: 3rem; }
            .adv-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- Navigation -->
<nav class="navbar">
    <div class="nav-content">
        <a href="#" class="logo">‚ö° FlowState</a>
        <div class="nav-links">
            <a href="tasks.html" style="color: var(--accent-green);">Tasks</a>
            <a href="breathe.html">Breathe</a>
            <a href="custom.html">Timer</a>
            <a href="days.html">Days</a>

        </div>
    </div>
</nav>

<div class="main-wrapper">
    
    <!-- Hero Section -->
    <section class="hero-section">
        <div class="app-container">
            <!-- Left Control Panel -->
            <div class="card control-panel">
                <div class="mode-switch">
                    <button class="mode-btn active" id="btn-pomodoro" onclick="app.setMode('pomodoro')">üçÖ Pomodoro</button>
                    <button class="mode-btn" id="btn-stopwatch" onclick="app.setMode('stopwatch')">‚è±Ô∏è Stopwatch</button>
                </div>
                <div class="project-row">
                    <select id="projectSelect" class="project-select"></select>
                    <button class="icon-btn" onclick="app.ui.toggleModal(true)" title="Manage Projects">‚öôÔ∏è</button>
                </div>
                
                <!-- Task Display -->
                <div id="current-task-display" style="
                    color: var(--accent-green); 
                    font-size: 1.1rem; 
                    margin-top: 5px;
                    min-height: 1.5rem; 
                    opacity: 0.9;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                    text-align: center;
                    font-weight: 600;
                "></div>
                
                <!-- Timer -->
                <div class="timer-display" id="timerDisplay">25:00</div>

                <!-- Sound Bar -->
                <div class="sound-bar">
                    <div class="sound-icons">
                        <button class="sound-btn" onclick="app.audio.toggle('rain')" title="Light Rain">üåßÔ∏è</button>
                        <button class="sound-btn" onclick="app.audio.toggle('forest')" title="Forest Birds">üê¶</button>
                        <button class="sound-btn" onclick="app.audio.toggle('waves')" title="Ocean Waves">üåä</button>
                        <button class="sound-btn" onclick="app.audio.toggle('fire')" title="Campfire">üî•</button>
                    </div>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span style="font-size:0.8rem;">üîä</span>
                        <input type="range" min="0" max="1" step="0.1" value="0.5" class="volume-slider" oninput="app.audio.setVolume(this.value)">
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-start" id="startBtn" onclick="app.start()">Start</button>
                    <button class="btn btn-stop" id="stopBtn" onclick="app.stop()" disabled>Finish</button>
                    <button class="btn btn-reset" onclick="app.reset()">Reset</button>
                </div>
                
                <!-- Recent Logs -->
                <div style="flex: 1; margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h2 style="margin:0; font-size:1.1rem;">Recent Logs</h2>
                        <div style="display:flex; gap:8px;">
                            <button onclick="app.data.exportData()" style="background:none; border:none; color:var(--text-secondary); cursor:pointer; font-size:0.8rem;">‚¨áÔ∏è Backup</button>
                            <label style="background:none; border:none; color:var(--text-secondary); cursor:pointer; font-size:0.8rem;">
                                ‚¨ÜÔ∏è Restore
                                <input type="file" style="display:none" onchange="app.data.importData(this)">
                            </label>
                        </div>
                    </div>
                    <div id="recentLogs" class="log-list"></div>
                </div>
            </div>

            <!-- Right Dashboard -->
            <div class="dashboard-grid">
                <div class="stats-row">
                    <div class="card">
                        <h2>üìä Project Distribution</h2>
                        <div class="chart-container"><canvas id="pieChart"></canvas></div>
                    </div>
                    <div class="card">
                        <h2>üìà 7-Day Trend</h2>
                        <div class="chart-container"><canvas id="barChart"></canvas></div>
                    </div>
                </div>
                <div class="card">
                    <h2>üìÖ Today's Overview</h2>
                    <div style="display: flex; gap: 40px;">
                        <div><div style="font-size: 0.9rem; color: var(--text-secondary);">Total Focus</div><div style="font-size: 2rem; font-weight: bold;" id="todayTotal">0h 0m 0s</div></div>
                        <div><div style="font-size: 0.9rem; color: var(--text-secondary);">Sessions</div><div style="font-size: 2rem; font-weight: bold;" id="todayCount">0</div></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ========================================== -->
    <!-- ADVANCED STATISTICS MODULE -->
    <!-- ========================================== -->
    <section class="adv-stats-section" id="advanced-stats-module">
        <div class="card" style="padding-bottom: 30px;">
            <!-- Controls -->
            <div class="adv-controls">
                <h2 style="margin:0; font-size:1.2rem; color:white;">üîé Detailed Analysis</h2>
                
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <!-- Dimension Switch -->
                    <div class="mode-switch" style="margin:0;">
                        <button id="adv-btn-day" class="mode-btn active">Day</button>
                        <button id="adv-btn-week" class="mode-btn">Week</button>
                        <button id="adv-btn-month" class="mode-btn">Month</button>
                        <button id="adv-btn-year" class="mode-btn">Year</button>
                    </div>

                    <!-- Date Navigator -->
                    <div class="date-navigator-wrapper">
                        <button onclick="AdvancedStats.move(-1)" class="nav-arrow" title="Previous">‚óÄ</button>
                        
                        <!-- CLICKABLE AREA -->
                        <div class="date-picker-container" onclick="try{document.getElementById('adv-date-picker').showPicker()}catch(e){document.getElementById('adv-date-picker').focus()}">
                            <div class="date-label-group">
                                <span id="adv-date-label">Today</span>
                                <span style="font-size: 0.8rem; opacity: 0.6;">üìÖ</span>
                            </div>
                            <input type="date" id="adv-date-picker" onchange="AdvancedStats.pickDate(this.value)" title="Jump to date">
                        </div>

                        <button onclick="AdvancedStats.move(1)" class="nav-arrow" title="Next">‚ñ∂</button>
                        <button onclick="AdvancedStats.resetDate()" class="nav-arrow" style="color:var(--accent-blue);" title="Back to Today">‚Ü∫</button>
                    </div>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="adv-grid">
                <!-- Pie -->
                <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
                    <h3 style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 15px;">Time Allocation</h3>
                    <div style="height: 220px; position: relative;">
                        <canvas id="adv-pie-chart"></canvas>
                    </div>
                </div>

                <!-- Bar (Scrollable) -->
                <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden;">
                    <h3 style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 15px;">Timeline & Trend</h3>
                    <div class="scroll-container">
                        <div style="height: 220px; min-width: 100%; position: relative;" id="adv-bar-wrapper">
                            <canvas id="adv-bar-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- SEO Content -->
    <div class="seo-wrapper">
        <article class="seo-content">
            <header class="section-header">
                <h1 class="section-title">The Ultimate Free Online<br>Pomodoro Timer & Focus Tracker</h1>
                <p class="section-subtitle">Struggling with procrastination? FlowState combines the proven <strong>Pomodoro Technique</strong> with immersive <strong>nature sounds</strong> and detailed <strong>productivity analytics</strong> to help you achieve deep work instantly.</p>
            </header>

            <div class="features-grid">
                <div class="feature-card">
                    <span class="f-icon">üçÖ</span>
                    <h2 class="f-title">Customizable Pomodoro Timer</h2>
                    <p class="f-desc">Adapt the 25/5 minute rule to your workflow. Whether you need a <strong>study timer</strong>, a work interval tracker, or a simple countdown, FlowState adapts to your needs without complex setups.</p>
                </div>
                <div class="feature-card">
                    <span class="f-icon">üéß</span>
                    <h2 class="f-title">Focus Sounds for ADHD</h2>
                    <p class="f-desc">Block out distracting noise. Our built-in <strong>white noise generator</strong> features high-quality Rain, Forest, and Campfire sounds, perfect for users with ADHD or those working in noisy environments.</p>
                </div>
                <div class="feature-card">
                    <span class="f-icon">üìà</span>
                    <h2 class="f-title">Visual Productivity Analytics</h2>
                    <p class="f-desc">Stop guessing where your time goes. Track your study hours, coding sessions, and work blocks with our interactive <strong>time tracking charts</strong>. Export your data anytime.</p>
                </div>
            </div>

            <div class="faq-section">
                <h2 style="font-size: 1.8rem; margin-bottom: 30px; color: white;">Frequently Asked Questions</h2>
                <div class="faq-item">
                    <h3 class="faq-question">What is the Pomodoro Technique?</h3>
                    <p class="faq-answer">The Pomodoro Technique is a time management method developed by Francesco Cirillo. It uses a timer to break work into intervals, traditionally 25 minutes in length, separated by short breaks. FlowState is the perfect <strong>digital Pomodoro timer</strong> to practice this method.</p>
                </div>
                <div class="faq-item">
                    <h3 class="faq-question">Is this focus timer free to use?</h3>
                    <p class="faq-answer">Yes, FlowState is a 100% <strong>free online focus timer</strong>. There are no hidden fees, no login requirements, and your data is stored locally on your device for privacy.</p>
                </div>
                <div class="faq-item">
                    <h3 class="faq-question">Does nature sound help with studying?</h3>
                    <p class="faq-answer">Absolutely. Studies show that ambient noise like rain or forest sounds can improve concentration and cognitive performance. Our <strong>background noise generator</strong> is designed to mask distracting sounds and induce a state of flow.</p>
                </div>
            </div>
        </article>
    </div>

</div>

<!-- Footer -->
<footer>
    <p>&copy; 2024 FlowState App. The best tool for Time Blocking & Deep Work.</p>
    <div style="margin-top: 10px; opacity: 0.6; font-size: 0.8rem;">
        <a href="#" style="color: inherit; margin: 0 10px;">Privacy Policy</a> | 
        <a href="#" style="color: inherit; margin: 0 10px;">Terms of Service</a> | 
        <a href="#" style="color: inherit; margin: 0 10px;">Contact</a>
    </div>
</footer>

<!-- Modal -->
<div class="modal-overlay" id="projectModal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h3>Manage Projects</h3>
            <button onclick="app.ui.toggleModal(false)" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">√ó</button>
        </div>
        <div class="add-form">
            <input type="text" id="newProjectName" class="input-text" placeholder="Project name...">
            <input type="color" id="newProjectColor" class="input-color" value="#3b82f6">
            <button class="btn btn-start" style="flex: 0 0 60px;" onclick="app.data.addProject()">Add</button>
        </div>
        <div id="projectList" style="max-height: 300px; overflow-y: auto;"></div>
    </div>
</div>

<!-- Audio Assets -->
<audio id="bg-rain" loop src="https://assets.mixkit.co/active_storage/sfx/2393/2393-preview.mp3"></audio>
<audio id="bg-forest" loop src="https://assets.mixkit.co/active_storage/sfx/2472/2472-preview.mp3"></audio>
<audio id="bg-waves" loop src="https://assets.mixkit.co/active_storage/sfx/1196/1196-preview.mp3"></audio>
<audio id="bg-fire" loop src="https://assets.mixkit.co/active_storage/sfx/2405/2405-preview.mp3"></audio>

<script>
// ==========================================
// 1. CORE TIMER LOGIC (TimeMaster)
// ==========================================
class TimeMaster {
    constructor() {
        // üöÄ UPDATED: Added currentTaskName to state
        this.state = { mode: 'pomodoro', isRunning: false, startTime: null, duration: 25 * 60, timerId: null, selectedProjectId: null, currentTaskName: null };
        try {
            const raw = localStorage.getItem('flowStateDB');
            this.db = raw ? JSON.parse(raw) : this.getDefaultDB();
            if (!this.db.projects || !Array.isArray(this.db.projects)) this.db = this.getDefaultDB();
        } catch (e) { this.db = this.getDefaultDB(); }
        this.state.selectedProjectId = this.db.projects[0]?.id;
        this.charts = { pie: null, bar: null };
        this.init();
    }
    
    getDefaultDB() {
        return {
            logs: [],
            projects: [
                { id: 'p1', name: 'üíª Coding', color: '#3b82f6' },
                { id: 'p2', name: 'üìö Learning', color: '#10b981' },
                { id: 'p3', name: '‚òï Break', color: '#f59e0b' }
            ]
        };
    }
    
        init() {
        this.cacheDOM();
        
        // ‚úÖ 1. Êñ∞Â¢ûÔºöËØ∑Ê±ÇÈÄöÁü•ÊùÉÈôê
        if ("Notification" in window && Notification.permission !== "granted") {
            Notification.requestPermission();
        }

        this.bindEvents();
        this.renderProjectSelect();
        
        // Check for URL parameters from tasks.html
        this.checkURLParams();
        
        this.updateUI();
        setTimeout(() => this.initCharts(), 100);
    }

    
    cacheDOM() {
        this.dom = {
            display: document.getElementById('timerDisplay'),
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            projectSelect: document.getElementById('projectSelect'),
            recentLogs: document.getElementById('recentLogs'),
            todayTotal: document.getElementById('todayTotal'),
            todayCount: document.getElementById('todayCount'),
            modal: document.getElementById('projectModal'),
            projectList: document.getElementById('projectList'),
            newProjectName: document.getElementById('newProjectName'),
            newProjectColor: document.getElementById('newProjectColor')
        };
    }
    
    bindEvents() {
        this.dom.projectSelect.addEventListener('change', (e) => this.state.selectedProjectId = e.target.value);
        this.dom.modal.addEventListener('click', (e) => { if (e.target === this.dom.modal) this.ui.toggleModal(false); });
        
        // Prevent accidental tab closing when timer is running
        window.addEventListener('beforeunload', (e) => {
            if (this.state.isRunning) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });
    }
    
    // üöÄ NEW FUNCTION: Handle URL parameters & Save Task Name
    checkURLParams() {
        const params = new URLSearchParams(window.location.search);
        const task = params.get('task');
        const pid = params.get('projectId');
        const mode = params.get('mode');
        const auto = params.get('autoStart');

        // 1. Set Project
        if (pid && this.getProject(pid)) {
            this.state.selectedProjectId = pid;
            this.dom.projectSelect.value = pid;
        }

        // 2. Set Mode
        if (mode === 'stopwatch' || mode === 'pomodoro') {
            this.setMode(mode);
        }

        // 3. Set Task Name Display & SAVE TO STATE
        if (task) {
            this.state.currentTaskName = task; // üëà ‰øùÂ≠ò‰ªªÂä°ÂêçÂà∞Áä∂ÊÄÅ
            const display = document.getElementById('current-task-display');
            if (display) display.textContent = task;
            document.title = `‚ñ∂ ${task}`;
        }

        // 4. Auto Start
        if (auto === 'true') {
            this.start();
        }
        
        // 5. Clean URL to prevent re-triggering on refresh
        if (task || pid || mode) {
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    }
    
    // Audio Logic
    audio = {
        current: null,
        volume: 0.5,
        toggle: (type) => {
            const id = `bg-${type}`;
            const el = document.getElementById(id);
            const btn = document.querySelector(`button[onclick="app.audio.toggle('${type}')"]`);
            
            if (this.audio.current === el && !el.paused) {
                el.pause();
                this.audio.current = null;
                btn.classList.remove('active');
            } else {
                ['rain', 'forest', 'waves', 'fire'].forEach(t => {
                    const other = document.getElementById(`bg-${t}`);
                    if(other) other.pause();
                    const b = document.querySelector(`button[onclick="app.audio.toggle('${t}')"]`);
                    if(b) b.classList.remove('active');
                });
                
                el.volume = this.audio.volume;
                el.play();
                this.audio.current = el;
                btn.classList.add('active');
            }
        },
        setVolume: (val) => {
            this.audio.volume = val;
            if (this.audio.current) this.audio.current.volume = val;
        }
    };
    
    ui = {
        toggleModal: (show) => {
            if (show) { this.dom.modal.classList.add('open'); this.renderProjectManager(); }
            else { this.dom.modal.classList.remove('open'); }
        }
    };
    
    data = {
        addProject: () => {
            const name = this.dom.newProjectName.value.trim();
            if (!name) return;
            this.db.projects.push({ id: 'p_' + Date.now(), name, color: this.dom.newProjectColor.value });
            this.saveDB();
            this.dom.newProjectName.value = '';
            this.renderProjectSelect();
            this.renderProjectManager();
        },
        deleteProject: (id) => {
            if (this.db.projects.length <= 1) return alert('Keep at least one project.');
            this.db.projects = this.db.projects.filter(p => p.id !== id);
            if (this.state.selectedProjectId === id) this.state.selectedProjectId = this.db.projects[0].id;
            this.saveDB();
            this.renderProjectSelect();
            this.renderProjectManager();
        },
        deleteLog: (id) => {
            if(!confirm('Delete this log?')) return;
            this.db.logs = this.db.logs.filter(l => l.id !== id);
            this.saveDB();
            this.updateUI();
            if(typeof AdvancedStats !== 'undefined') AdvancedStats.refresh();
        },
        exportData: () => {
            const blob = new Blob([JSON.stringify(this.db, null, 2)], { type: "application/json" });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `flowstate_backup.json`;
            a.click();
        },
        importData: (input) => {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.logs && data.projects) {
                        localStorage.setItem('flowStateDB', JSON.stringify(data));
                        alert('Data restored successfully! Reloading...');
                        location.reload();
                    } else {
                        alert('Invalid file format.');
                    }
                } catch(err) { alert('Error parsing file.'); }
            };
            reader.readAsText(file);
        }
    };
    
    saveDB() { localStorage.setItem('flowStateDB', JSON.stringify(this.db)); }
    
    setMode(mode) {
        if (this.state.isRunning) return alert('Please stop the timer first.');
        this.state.mode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(mode === 'stopwatch' ? 'btn-stopwatch' : 'btn-pomodoro').classList.add('active');
        this.reset();
    }
    
    start() {
        if (this.state.isRunning) return;
        this.state.isRunning = true;
        this.state.startTime = Date.now();
        this.dom.startBtn.disabled = true;
        this.dom.stopBtn.disabled = false;
        this.dom.startBtn.style.opacity = '0.5';
        this.dom.display.classList.remove('timer-finished');

        this.state.timerId = setInterval(() => {
            const passed = Math.floor((Date.now() - this.state.startTime) / 1000);
            if (this.state.mode === 'stopwatch') this.updateDisplay(passed);
            else {
                const remaining = this.state.duration - passed;
                if (remaining <= 0) this.stop(true);
                else this.updateDisplay(remaining);
            }
        }, 1000);
    }
    
        stop(auto = false) {
        clearInterval(this.state.timerId);
        this.state.isRunning = false;
        this.dom.startBtn.disabled = false;
        this.dom.stopBtn.disabled = true;
        this.dom.startBtn.style.opacity = '1';
        const passed = Math.floor((Date.now() - this.state.startTime) / 1000);
        const duration = auto ? this.state.duration : passed;
        
        if (duration > 2) {
            this.db.logs.unshift({ 
                id: Date.now(), 
                projectId: this.state.selectedProjectId, 
                duration, 
                date: new Date().toISOString(),
                taskName: this.state.currentTaskName || null 
            });
            
            this.saveDB();
            this.updateUI();
            if(typeof AdvancedStats !== 'undefined') AdvancedStats.refresh();
            
            if (auto) {
                this.dom.display.classList.add('timer-finished');
                document.title = "üö® TIME IS UP!";
                
                // ‚úÖ 2. Êñ∞Â¢ûÔºöÂèëÈÄÅÈÄöÁü•
                if ("Notification" in window && Notification.permission === "granted") {
                    new Notification("üéâ Time is up!", {
                        body: "Great job! Take a break.",
                        icon: "https://cdn-icons-png.flaticon.com/512/2928/2928750.png"
                    });
                }
            }
        }
        if (!auto) this.reset();
    }

    
    reset() {
        if (this.state.isRunning) clearInterval(this.state.timerId);
        this.state.isRunning = false;
        this.dom.startBtn.disabled = false;
        this.dom.stopBtn.disabled = true;
        this.dom.display.classList.remove('timer-finished');
        this.updateDisplay(this.state.mode === 'pomodoro' ? this.state.duration : 0);
    }
    
    updateDisplay(s) {
        const m = Math.floor(s / 60).toString().padStart(2, '0');
        const sec = (s % 60).toString().padStart(2, '0');
        this.dom.display.textContent = `${m}:${sec}`;
        if (!this.dom.display.classList.contains('timer-finished')) document.title = `${m}:${sec} - FlowState`;
    }
    
    getProject(id) { return this.db.projects.find(p => p.id === id) || { name: 'Unknown', color: '#64748b' }; }
    
    renderProjectSelect() {
        this.dom.projectSelect.innerHTML = this.db.projects.map(p => 
            `<option value="${p.id}" ${p.id === this.state.selectedProjectId ? 'selected' : ''}>${p.name}</option>`
        ).join('');
        this.state.selectedProjectId = this.dom.projectSelect.value;
    }
    
    renderProjectManager() {
        this.dom.projectList.innerHTML = this.db.projects.map(p => `
            <div class="project-list-item">
                <div style="display:flex; align-items:center; gap:10px;">
                    <div style="width:12px; height:12px; border-radius:50%; background:${p.color}"></div>
                    <span>${p.name}</span>
                </div>
                <button onclick="app.data.deleteProject('${p.id}')" class="delete-btn">Delete</button>
            </div>
        `).join('');
    }
    
    updateUI() {
        this.dom.recentLogs.innerHTML = this.db.logs.slice(0, 10).map(log => {
            const p = this.getProject(log.projectId);
            const d = new Date(log.date);
            
            // üöÄ UPDATED: Display Task Name if exists
            const taskLabel = log.taskName ? ` <span style="opacity:0.7; font-size:0.85em;">‚Äî ${log.taskName}</span>` : '';
            
            return `
                <div class="log-item">
                    <div>
                        <span style="color:${p.color}">‚óè</span> 
                        ${p.name}${taskLabel}
                        <span style="font-size:0.8rem; opacity:0.5; margin-left:5px;">
    ${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}
</span>

                    </div>
                    <div>${Math.floor(log.duration / 60)}m <button class="delete-btn" onclick="app.data.deleteLog(${log.id})">‚úñ</button></div>
                </div>`;
        }).join('') || '<div style="text-align:center; padding:20px; opacity:0.5">No logs yet</div>';
        
        const today = new Date().toISOString().split('T')[0];
        const logs = this.db.logs.filter(l => l.date.startsWith(today));
        const total = logs.reduce((a, b) => a + b.duration, 0);
        this.dom.todayTotal.textContent = `${Math.floor(total / 3600)}h ${Math.floor((total % 3600) / 60)}m`;
        this.dom.todayCount.textContent = logs.length;
        if (this.charts.pie) this.updateCharts();
    }
    
    initCharts() {
        if (typeof Chart === 'undefined') return;
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';
        this.charts.pie = new Chart(document.getElementById('pieChart'), {
            type: 'doughnut', data: { labels: [], datasets: [] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', display: false } } }
        });
        this.charts.bar = new Chart(document.getElementById('barChart'), {
            type: 'bar', data: { labels: [], datasets: [] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
        this.updateCharts();
    }
    
    updateCharts() {
        if (!this.charts.pie) return;
        const pieStats = {};
        this.db.logs.forEach(l => { if (!pieStats[l.projectId]) pieStats[l.projectId] = 0; pieStats[l.projectId] += l.duration; });
        const pLabels = [], pData = [], pColors = [];
        Object.keys(pieStats).forEach(pid => {
            const p = this.getProject(pid);
            pLabels.push(p.name); pData.push((pieStats[pid]/60).toFixed(1)); pColors.push(p.color);
        });
        this.charts.pie.data = { labels: pLabels, datasets: [{ data: pData, backgroundColor: pColors, borderWidth: 0 }] };
        this.charts.pie.update();
        
        const bLabels = [], bData = {};
        for(let i=6; i>=0; i--) {
            const d = new Date(); d.setDate(d.getDate()-i);
            const k = d.toISOString().split('T')[0];
            bLabels.push(`${d.getMonth()+1}/${d.getDate()}`);
            bData[k] = 0;
        }
        this.db.logs.forEach(l => { const k = l.date.split('T')[0]; if(bData.hasOwnProperty(k)) bData[k] += l.duration; });
        this.charts.bar.data = { labels: bLabels, datasets: [{ label: 'Min', data: Object.values(bData).map(v=>(v/60).toFixed(1)), backgroundColor: '#3b82f6', borderRadius: 4 }] };
        this.charts.bar.update();
    }
}

const app = new TimeMaster();

// ==========================================
// 2. ADVANCED STATISTICS LOGIC (PERFECTED)
// ==========================================
const AdvancedStats = {
    charts: { pie: null, bar: null },
    currentMode: 'day',
    cursorDate: new Date(),

    init: function() {
        ['day', 'week', 'month', 'year'].forEach(mode => {
            const btn = document.getElementById(`adv-btn-${mode}`);
            if(btn) btn.onclick = () => this.switchMode(mode);
        });
        this.switchMode('day');
        console.log("Advanced Stats Initialized");
    },

    pickDate: function(dateStr) {
        if (!dateStr) return;
        const [y, m, d] = dateStr.split('-').map(Number);
        this.cursorDate = new Date(y, m - 1, d);
        this.refresh();
    },

    move: function(direction) {
        const d = new Date(this.cursorDate);
        if (this.currentMode === 'day') d.setDate(d.getDate() + direction);
        else if (this.currentMode === 'week') d.setDate(d.getDate() + (direction * 7));
        else if (this.currentMode === 'month') d.setMonth(d.getMonth() + direction);
        else if (this.currentMode === 'year') d.setFullYear(d.getFullYear() + direction);
        this.cursorDate = d;
        this.refresh();
    },

    resetDate: function() {
        this.cursorDate = new Date();
        this.refresh();
    },

    switchMode: function(mode) {
        this.currentMode = mode;
        document.querySelectorAll('.adv-controls .mode-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`adv-btn-${mode}`).classList.add('active');
        this.refresh();
    },

    refresh: function() {
        const range = this.getDateRange(this.currentMode, this.cursorDate);
        document.getElementById('adv-date-label').innerText = range.label;
        
        // Sync invisible picker
        const y = this.cursorDate.getFullYear();
        const m = String(this.cursorDate.getMonth() + 1).padStart(2, '0');
        const d = String(this.cursorDate.getDate()).padStart(2, '0');
        const picker = document.getElementById('adv-date-picker');
        if(picker) picker.value = `${y}-${m}-${d}`;

        const logs = app.db.logs;
        const filteredLogs = logs.filter(l => {
            const logDate = new Date(l.date);
            return logDate >= range.start && logDate <= range.end;
        });

        this.renderCharts(filteredLogs, this.currentMode, range);
    },

    getDateRange: function(mode, date) {
        const start = new Date(date);
        let end = new Date(date);
        let label = "";
        const now = new Date();

        if (mode === 'day') {
            start.setHours(0,0,0,0);
            end = new Date(start); end.setHours(23,59,59,999);
            const isToday = now.toDateString() === start.toDateString();
            const isYesterday = new Date(new Date().setDate(now.getDate()-1)).toDateString() === start.toDateString();
            label = isToday ? "Today" : (isYesterday ? "Yesterday" : start.toLocaleDateString());
        } 
        else if (mode === 'week') {
            const day = start.getDay();
            const diff = start.getDate() - day + (day === 0 ? -6 : 1); 
            start.setDate(diff); start.setHours(0,0,0,0);
            end = new Date(start); end.setDate(start.getDate() + 6); end.setHours(23,59,59,999);
            label = `${start.getMonth()+1}/${start.getDate()} - ${end.getMonth()+1}/${end.getDate()}`;
        } 
        else if (mode === 'month') {
            start.setDate(1); start.setHours(0,0,0,0);
            end = new Date(start); end.setMonth(start.getMonth() + 1); end.setDate(0); end.setHours(23,59,59,999);
            label = start.toLocaleDateString(undefined, { year: 'numeric', month: 'long' });
        } 
        else if (mode === 'year') {
            start.setMonth(0, 1); start.setHours(0,0,0,0);
            end = new Date(start); end.setMonth(11, 31); end.setHours(23,59,59,999);
            label = start.getFullYear().toString();
        }
        return { start, end, label };
    },

    renderCharts: function(logs, mode, range) {
        if (typeof Chart === 'undefined') return;

        // Pie
        const pieMap = {};
        logs.forEach(l => { if(!pieMap[l.projectId]) pieMap[l.projectId] = 0; pieMap[l.projectId] += l.duration; });
        const pieLabels = [], pieData = [], pieColors = [];
        Object.keys(pieMap).forEach(pid => {
            const p = app.getProject(pid);
            pieLabels.push(p.name); pieData.push((pieMap[pid] / 60).toFixed(1)); pieColors.push(p.color);
        });

        // Bar
        let barLabels = [], barDataMap = {};
        if (mode === 'day') {
            for(let i=0; i<24; i++) { barLabels.push(i + ":00"); barDataMap[i] = 0; }
            logs.forEach(l => { barDataMap[new Date(l.date).getHours()] += l.duration; });
        } else if (mode === 'week') {
            const curr = new Date(range.start);
            for(let i=0; i<7; i++) {
                barLabels.push(`${curr.getMonth()+1}/${curr.getDate()}`);
                barDataMap[curr.toISOString().split('T')[0]] = 0;
                curr.setDate(curr.getDate() + 1);
            }
            logs.forEach(l => { const k = new Date(l.date).toISOString().split('T')[0]; if(barDataMap[k] !== undefined) barDataMap[k] += l.duration; });
        } else if (mode === 'month') {
            const days = range.end.getDate();
            for(let i=1; i<=days; i++) { barLabels.push(i); barDataMap[i] = 0; }
            logs.forEach(l => { barDataMap[new Date(l.date).getDate()] += l.duration; });
        } else if (mode === 'year') {
            barLabels = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            barLabels.forEach((_, i) => barDataMap[i] = 0);
            logs.forEach(l => { barDataMap[new Date(l.date).getMonth()] += l.duration; });
        }

        // Render Pie
        const ctxPie = document.getElementById('adv-pie-chart');
        if(this.charts.pie) this.charts.pie.destroy();
        this.charts.pie = new Chart(ctxPie, {
            type: 'doughnut',
            data: { labels: pieLabels.length ? pieLabels : ['No Data'], datasets: [{ data: pieData.length ? pieData : [1], backgroundColor: pieColors.length ? pieColors : ['rgba(255,255,255,0.1)'], borderWidth: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#94a3b8', boxWidth: 12 } } } }
        });

        // Render Bar
        const ctxBar = document.getElementById('adv-bar-chart');
        const wrapper = document.getElementById('adv-bar-wrapper');
        if(wrapper) wrapper.style.width = mode === 'month' ? '800px' : '100%';

        if(this.charts.bar) this.charts.bar.destroy();
        this.charts.bar = new Chart(ctxBar, {
            type: 'bar',
            data: { labels: barLabels, datasets: [{ label: 'Minutes', data: Object.values(barDataMap).map(v=>(v/60).toFixed(1)), backgroundColor: '#3b82f6', borderRadius: 4, barThickness: mode === 'month' ? 12 : 'flex' }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }, x: { grid: { display: false }, ticks: { color: '#94a3b8' } } } }
        });
    }
};

// Initialize after DOM load
setTimeout(() => {
    if(typeof AdvancedStats !== 'undefined') AdvancedStats.init();
}, 500);
</script>
<script>
    // Ê≥®ÂÜå PWA Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('Service Worker Ê≥®ÂÜåÊàêÂäü:', reg.scope))
                .catch(err => console.log('Service Worker Ê≥®ÂÜåÂ§±Ë¥•:', err));
        });
    }
</script>

</body>
</html>

